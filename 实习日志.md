# å®ä¹ æ—¥å¿—

## 2023-2-20 Â· å‘¨ä¸€

### å…¥èŒ

- [x] é¢†å–è®¾å¤‡
- [x] æ‰¾åˆ°å·¥ä½
- [x] é…ç½®ç¯å¢ƒ
- [x] è®¤è¯†åŒäº‹





## 2023-2-21 Â· å‘¨äºŒ

### éœ€æ±‚

grafanaä»ªè¡¨ç›˜ã€Prometheus



### **æœŸæœ›**

grafanaä»ªè¡¨ç›˜å…·å¤‡å¦‚ä¸‹å›¾æ ‡å±•ç¤ºï¼š

1. è€—æ—¶ 
2. æˆåŠŸç‡ 
3. qps

éœ€è¦ä»¥ä¸‹ç»´åº¦çš„ label
1. è°ƒç”¨ç»„ä»¶ app
2. æ–‡æœ¬/å›¾ç‰‡/å…¨é‡è§£æ mode(text/image/all)
3. æ–‡ä»¶å¤§å°åŒºé—´(200-500 500-1g 1g-2g >2g) size
4. æ–‡ä»¶æ ¼å¼  ext
5. é”™è¯¯ç    http_code
6. ä¸šåŠ¡æ–¹  biz
7. åœºæ™¯  scene



Grafana-Prometheusæµç¨‹å›¾ï¼š

![](D:\å®ä¹ ä»“åº“\Daily_notes\images\Grafana-Prometheus.png)



Prometheuså››ç§æ•°æ®ç±»å‹

```go
// è®¡æ•°å™¨ç±»å‹ï¼Œä¾‹å¦‚è®°å½•è¯·æ±‚æ¬¡æ•°ã€ä»»åŠ¡å®Œæˆæ•°ã€é”™è¯¯å‘ç”Ÿæ¬¡æ•°
counter

// æµ‹é‡å™¨ç±»å‹ï¼Œä¾‹å¦‚æ¸©åº¦å˜åŒ–ã€å†…å­˜ä½¿ç”¨å˜åŒ–
gauge

// è®¡ç®—æŒ‡æ ‡ã€è¡¨ç¤ºé‡‡æ ·æ•°æ®ç»“æœç­‰ï¼ŒåŒ…å«ï¼š_bucketã€_sumã€_countä¸‰é¡¹æŒ‡æ ‡
histogram

// è¡¨ç¤ºä¸€æ®µæ—¶é—´å†…çš„æ•°æ®é‡‡æ ·çš„ç»“æœï¼ŒåŒ…å«ï¼šè§‚å¯Ÿæ—¶é—´çš„Ï†-quantiles (0 â‰¤ Ï† â‰¤ 1)ï¼ˆåˆ†ä½æ•°ï¼‰ã€_sumã€_count
summary
```



### è®¡åˆ’

- å‰æœŸå‡†å¤‡:

  - æ­å»ºgrafanaç¯å¢ƒ
  - æ­å»ºprometheusç¯å¢ƒ
  - æ­å»ºgoç¯å¢ƒ
  - æ–°å¯goå·¥ç¨‹ï¼Œå¹¶å®‰è£…ç›¸åº”ä¾èµ–
  - å­¦ä¹ PromQL
  - goçš„[prometheusåº“](https://pkg.go.dev/github.com/prometheus/client_golang@v1.14.0/prometheus)

  

- å®ç°æ€è·¯ï¼š

  - ç¼–å†™goç¨‹åºå°†æ•°æ®æºæ•°æ®æ¨åˆ°prometheus
  - grafanaè®¾ç½®æ•°æ®æºä¸ºpromethues
  - grafanaè®¾ç½®å‡½æ•°å¹¶æ·»åŠ ç›¸åº”æ¨¡å—ã€å›¾è¡¨Â·Â·Â·Â·Â·Â·
  - é¢„è§ˆè¾“å‡º

  

- ä¸€äº›å›°æƒ‘

  - prometheuséœ€è¦åœ¨é…ç½®ä¸­ç»‘å®šæ•°æ®æºï¼Œå³ç›‘å¬çš„httpè¯·æ±‚ï¼Œæ‰å¯è·å–æ•°æ®ï¼Œé‚£ä¹ˆå¦‚ä½•å°è£…ä¸€å¥—ç¨‹åºæ¥å®ç°exporter?

    - æ— éœ€å°ä½ï¼Œä¸é‡‡ç”¨prometheusè‡ªå·±çš„å®šæ—¶æ‹‰å–æ–¹æ³•ï¼Œéœ€è¦å°è£…çš„æ˜¯æˆ‘ä»¬æ¨é€æ•°æ®çš„æ–¹æ³•

  - æ•°æ®è·å–æ–¹æ³•ï¼Œæ˜¯å¦éœ€è¦ä¸€èµ·å°è£…ï¼Ÿ

    - ä¸éœ€è¦ï¼Œç›´æ¥è°ƒæ¥å£æ‹¿æ•°æ®

  - grafanaéƒ¨åˆ†è®¡åˆ’æ˜¯ï¼Ÿ

    - éœ€è¦å¯¹prometheusçš„æ•°æ®æºçš„æ•°æ®ï¼Œè¿›è¡Œä¸€ä¸ªè¿‡æ»¤ã€è®¾è®¡å’Œå‹å¥½å±•ç¤ºä»¥åŠåŒºé—´è®¾å®šï¼Œç”Ÿæˆè‰¯å¥½æ ¼å¼çš„Jsonï¼Œå¯å¤ç”¨ã€‚

    

- å®ç°éš¾ç‚¹

  - Goå°è£…æ¨é€prometheusæ¨é€åŠŸèƒ½ï¼ˆæ•°æ®ä¸Šä¼ prometheusï¼‰
  - PromQLè¯­å¥å­¦ä¹ ï¼ˆè¿‡æ»¤ã€èµ›é€‰ã€ç±»ä¼¼sqlï¼‰



## 2023-2-22 Â· å‘¨ä¸‰

### è®¡åˆ’

- å…¨éƒ¨å®Œæˆprometheusæ¨é€æ•°æ®ç»“æ„ä½“åŠæ–¹æ³•çš„å°è£…
- å®Œæˆéƒ¨åˆ†grafanaçš„ç»´åº¦è®¾è®¡

### è¿‡ç¨‹

- å°è£…é€»è¾‘ï¼š
  - ![](D:\å®ä¹ ä»“åº“\Daily_notes\images\prometheus_push.png)

- prometheusçš„ä¸€äº›æ¦‚å¿µï¼š
  - jobï¼šä»»åŠ¡ï¼Œå³ç›¸åŒç±»å‹instanceçš„é›†åˆ
  - instanceï¼šå®ä¾‹IPï¼Œå³ä¸€ä¸ªç‹¬ç«‹çš„target
  - targetï¼šæ•°æ®æº
  - metricsï¼šåç§°ï¼Œä¸labelsä¸€åŒæ„æˆæŸ¥è¯¢ä¸»é”®
    - `<metric name>{<label name>=<label value>, ...}`
  - labelsï¼šæ ‡ç­¾
  - timestampï¼šæ—¶é—´
  - sample valueï¼šå€¼
- é˜…è¯»å¹¶æ›´æ–°promå°è£…æ–¹æ³•



### ~~äº§å‡º~~

- promå°è£…å·²ç»ç›¸å¯¹å®Œå–„ï¼Œç›®å‰ä¸éœ€è¦è¿›ä¸€æ­¥å°è£…ï¼Œåˆæ­¥ä½¿ç”¨
- grafanaæš‚åœ



### è®¡åˆ’æœ‰å˜

æ–°ä»»åŠ¡ï¼š

- é’ˆå¯¹è·å–çš„å“åº”æ•°æ®ï¼Œè§„èŒƒä¸€å¥—å•ç‹¬çš„æ•°æ®æå–æ ‡å‡†ï¼Œå®šä¹‰ç»“æ„ä½“ï¼Œåç»­é€šè¿‡å°è£…çš„promè¿›è¡Œæ¶ˆè´¹

- ç»“æ„ä½“åˆæ­¥å½¢å¼ï¼š

  - ```go
    type KafkaDocument struct {
    	MsgId    string      `json:"msg_id"`
    	Data     interface{} `json:"data"`
    }
    
    func (d *KafkaDocument) Dispatch(topic string, msg []byte) bool {
    
    	return true
    }
    
    // ç»“æ„å¦‚ä¸‹ï¼š
    {
        "msg_id": "prometheus",
        "data": {
            "": 
        }
    }
    ```

- å­—æ®µåå›ºå®šï¼Œåˆå§‹å¦‚ä¸‹ï¼š

  - ```
    1. è€—æ—¶ 
    2. æˆåŠŸç‡ 
    3. qps
    
    éœ€è¦ä»¥ä¸‹ç»´åº¦çš„ label
    1. è°ƒç”¨ç»„ä»¶ app
    2. æ–‡æœ¬/å›¾ç‰‡/å…¨é‡è§£æ mode(text/image/all)
    3. æ–‡ä»¶å¤§å°åŒºé—´(200-500 500-1g 1g-2g >2g) size
    4. æ–‡ä»¶æ ¼å¼  ext
    5. é”™è¯¯ç    http_code
    6. ä¸šåŠ¡æ–¹  biz
    7. åœºæ™¯  scene
    ```



### äº§å‡º

- ~~å®ŒæˆPrometheusç»“æ„ä½“è®¾è®¡~~ï¼Œ
- **æ˜æ—¥å®Œæˆqpsçš„prometheuså’Œgrafanaå±•ç°**





### æ—¥å¸¸æ”¶è·

[P50ã€P90ã€P99ä»£è¡¨ä»€ä¹ˆï¼Ÿ](https://blog.csdn.net/Solo95/article/details/119110134)





## 2023-2-22 Â· å‘¨å››

### ç–‘æƒ‘

Add()/Inc()ï¼ŒSet()ï¼ŒOberve()è¿™ä¸‰ä¸ªæ–¹æ³•åé¢åˆ°åº•æ”¾ä»€ä¹ˆï¼Ÿ

costï¼Ÿæ—¶é—´ï¼Ÿ





### è§£ç­”

![](.\images\metricsç»“æ„.png)

![](.\images\è°ƒç”¨å…³ç³».png)





### è®¾è®¡

å‰æé¡»çŸ¥ï¼š

- ç±»å‹ï¼š

  - summaryï¼šç±»ä¼¼histogramï¼ˆæŒ‰æ ·æœ¬æ•°é‡åˆ’åˆ†ï¼Œåˆ’åˆ†%ï¼‰

  - Histogramï¼šç´¯è®¡ç›´æ–¹å›¾ï¼ˆæŒ‰æ ·æœ¬è¾¹ç•Œåˆ’åˆ†ï¼Œåˆ’åˆ†æ¡¶ï¼‰

  - counterï¼šæŠ˜çº¿å›¾ï¼Œåªå¢ä¸å‡ï¼Œé‡å¯ä»0å¼€å§‹ï¼Œé€šè¿‡Add()ã€Inc()å¢åŠ å€¼

  - gaugeï¼šåŠ¨æ€å˜åŒ–ï¼Œé€šè¿‡set()è®¾ç½®å€¼

- PromQLè®¡ç®—æ–¹æ³•ï¼š
  - sum()ï¼šèšåˆ
  - rate()ï¼šè®¡ç®—èŒƒå›´å‘é‡ä¸­æ—¶é—´åºåˆ—çš„**å¹³å‡**å¢é•¿ç‡
  - irate()ï¼šè®¡ç®—èŒƒå›´å‘é‡ä¸­æ—¶é—´åºåˆ—çš„æ¯ç§’**ç¬æ—¶**å¢é•¿ç‡



å¼€å§‹è®¾è®¡ï¼š

- QPSï¼šæ¯ç§’æŸ¥è¯¢ç‡
  - QPS = å“åº”æ•° / æ—¶é—´
  - ä»¥counterå±•ç°
    - æŠ˜çº¿å›¾
  - æ‰€éœ€metric:
    - `http_api_qps`
    - è®¡ç®—æ–¹æ³• `sum(http_api_qps)`



- è€—æ—¶ï¼šè€—æ—¶

  - ä»¥counterå±•ç°ï¼ˆ<u>**æš‚å­˜ç–‘æƒ‘ï¼Œcounterä¸æ˜¯åªå¢ä¸å‡å˜›ï¼Ÿ**</u>ï¼‰
    - æŠ˜çº¿å›¾
  - 1ã€æ‰€éœ€metric
    - `http_api_seconds`
    - è®¡ç®—æ–¹æ³• `sum(http_api_secondes)`
  - 2ã€ä»¥summaryï¼Œhistogramå±•ç°
    - æ‰€éœ€metric
    - `http_api_cost_seconds`
    - è®¡ç®—æ–¹æ³• ï¼šè®¾ç½®åˆ†ä½æ•°Â·Â·Â·Â·Â·Â·

  

- æˆåŠŸç‡ï¼š

  - æˆåŠŸç‡ = http_code = 200 / http_sum
  - ä»¥counterå±•ç°
    - æŠ˜çº¿å›¾
  - æ‰€éœ€metric:
    - `http_api_total`
    - è®¡ç®—æ–¹æ³• `rate(sum(http_api_total{http_code = "200"})`/ `sum(http_api_total))`





### äº§å‡º

- æ­å»ºå®Œæˆpushgatewayï¼Œprometheusã€grafana
- å®Œæˆgoè„šæœ¬çš„ç¼–å†™ï¼Œå®ç°æ¨é€åˆ°pushgatewayçš„æ–¹æ³•ï¼Œæµ‹è¯•æˆåŠŸæ¨é€å…­ä¸ªlabelã€3ä¸ªmetricåˆ°pushgatewayï¼Œå¹¶åœ¨prometheuså’Œgrafanaä¸­å±•ç°



## 2023-2-24 Â· å‘¨äº”

### è®¡åˆ’

1. å®Œæˆå›¾åƒè®¾è®¡ï¼šmetricsã€ç»Ÿè®¡æ–¹æ³•Â·Â·Â·Â·Â·Â·
2. ä¼˜åŒ–goè„šæœ¬



### äº§å‡º

- [x] å®Œæˆgoè„šæœ¬ä¼˜åŒ–ï¼Œgrafanaæ¥å…¥
- [ ] è¡¨æ ¼è®¾è®¡



### è®¡åˆ’æœ‰å˜

- [x] å®Œæˆ`æ ¼å¼-è½¯ä»¶`è¡¨æ ¼å¡«å†™

- [ ] CentOSä¸Šæµ‹è¯•è½¯ä»¶å¯è¡Œæ€§ï¼ˆunixç³»ç»Ÿï¼‰

  - æƒé™:

    - link_password: 333333
    - user: root
    - password: 123456

  - å®‰è£…è·¯å¾„ï¼š/app

    - ![xiezuo20230224-143713](C:\Users\wps\AppData\Roaming\xiezuo\ImageTempCache\xiezuo20230224-143713.png)

  - CentOSå®‰è£…è½¯ä»¶çš„ä¸‰ç§æ–¹æ³•

    - `rpm -i <package.rpm>` å®‰è£…

      - `rpm -q ...` æŸ¥è¯¢
      - `rpm -e ...` å¸è½½ 
      - `rpm -U ...` æ›´æ–°
      - `rpm -V ...` éªŒè¯

    - æºç æ–¹å¼

    - yumæ–¹å¼

      - ```shell
        yum [options] [command] [package ...]
        optionsï¼šå¯é€‰ï¼Œé€‰é¡¹åŒ…æ‹¬-hï¼ˆå¸®åŠ©ï¼‰ï¼Œ-yï¼ˆå½“å®‰è£…è¿‡ç¨‹æç¤ºé€‰æ‹©å…¨éƒ¨ä¸º"yes"ï¼‰ï¼Œ-qï¼ˆä¸æ˜¾ç¤ºå®‰è£…çš„è¿‡ç¨‹ï¼‰ç­‰ç­‰ã€‚
        commandï¼šè¦è¿›è¡Œçš„æ“ä½œã€‚
        packageæ“ä½œçš„å¯¹è±¡ã€‚
        
        options:
        -hï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼› 
        -yï¼šå¯¹æ‰€æœ‰çš„æé—®éƒ½å›ç­”â€œyesâ€ï¼› 
        -cï¼šæŒ‡å®šé…ç½®æ–‡ä»¶ï¼› 
        -qï¼šå®‰é™æ¨¡å¼ï¼› 
        -vï¼šè¯¦ç»†æ¨¡å¼ï¼› 
        -dï¼šè®¾ç½®è°ƒè¯•ç­‰çº§ï¼ˆ0-10ï¼‰ï¼› 
        -eï¼šè®¾ç½®é”™è¯¯ç­‰çº§ï¼ˆ0-10ï¼‰ï¼› 
        -Rï¼šè®¾ç½®yumå¤„ç†ä¸€ä¸ªå‘½ä»¤çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼› 
        -Cï¼šå®Œå…¨ä»ç¼“å­˜ä¸­è¿è¡Œï¼Œè€Œä¸å»ä¸‹è½½æˆ–è€…æ›´æ–°ä»»ä½•å¤´æ–‡ä»¶ã€‚
        
        command:
        
        installï¼šå®‰è£…rpmè½¯ä»¶åŒ…ï¼› 
        updateï¼šæ›´æ–°rpmè½¯ä»¶åŒ…ï¼› 
        check-updateï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„æ›´æ–°rpmè½¯ä»¶åŒ…ï¼› 
        removeï¼šåˆ é™¤æŒ‡å®šçš„rpmè½¯ä»¶åŒ…ï¼› 
        listï¼šæ˜¾ç¤ºè½¯ä»¶åŒ…çš„ä¿¡æ¯ï¼› 
        searchï¼šæ£€æŸ¥è½¯ä»¶åŒ…çš„ä¿¡æ¯ï¼› 
        infoï¼šæ˜¾ç¤ºæŒ‡å®šçš„rpmè½¯ä»¶åŒ…çš„æè¿°ä¿¡æ¯å’Œæ¦‚è¦ä¿¡æ¯ï¼› 
        cleanï¼šæ¸…ç†yumè¿‡æœŸçš„ç¼“å­˜ï¼› 
        shellï¼šè¿›å…¥yumçš„shellæç¤ºç¬¦ï¼› 
        resolvedepï¼šæ˜¾ç¤ºrpmè½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»ï¼› 
        localinstallï¼šå®‰è£…æœ¬åœ°çš„rpmè½¯ä»¶åŒ…ï¼› 
        localupdateï¼šæ˜¾ç¤ºæœ¬åœ°rpmè½¯ä»¶åŒ…è¿›è¡Œæ›´æ–°ï¼› 
        deplistï¼šæ˜¾ç¤ºrpmè½¯ä»¶åŒ…çš„æ‰€æœ‰ä¾èµ–å…³ç³»ã€‚
        
        
        yumå¸¸ç”¨å‘½ä»¤
        
        1.åˆ—å‡ºæ‰€æœ‰å¯æ›´æ–°çš„è½¯ä»¶æ¸…å•å‘½ä»¤ï¼šyum check-update
        2.æ›´æ–°æ‰€æœ‰è½¯ä»¶å‘½ä»¤ï¼šyum update
        3.ä»…å®‰è£…æŒ‡å®šçš„è½¯ä»¶å‘½ä»¤ï¼šyum install <package_name>
        4.ä»…æ›´æ–°æŒ‡å®šçš„è½¯ä»¶å‘½ä»¤ï¼šyum update <package_name>
        5.åˆ—å‡ºæ‰€æœ‰å¯å®‰è£çš„è½¯ä»¶æ¸…å•å‘½ä»¤ï¼šyum list
        6.åˆ é™¤è½¯ä»¶åŒ…å‘½ä»¤ï¼šyum remove <package_name>
        7.æŸ¥æ‰¾è½¯ä»¶åŒ… å‘½ä»¤ï¼šyum search <keyword>
        8.æ¸…é™¤ç¼“å­˜å‘½ä»¤:
        yum clean packages: æ¸…é™¤ç¼“å­˜ç›®å½•ä¸‹çš„è½¯ä»¶åŒ…
        yum clean headers: æ¸…é™¤ç¼“å­˜ç›®å½•ä¸‹çš„ headers
        yum clean oldheaders: æ¸…é™¤ç¼“å­˜ç›®å½•ä¸‹æ—§çš„ headers
        rpm -aq inotify-tools æŸ¥çœ‹æ˜¯å¦å®‰è£…
        yum clean, yum clean all (= yum clean packages; yum clean oldheaders) :æ¸…é™¤ç¼“å­˜ç›®å½•ä¸‹çš„è½¯ä»¶åŒ…åŠæ—§çš„headers
        è½¯ä»¶ç»„ï¼Œä¸è½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»
        ```





# ğŸŒ´2023-2-25â€”â€”2023-2-26 Â· å‘¨æœ«ingğŸŒ´





## 2023-2-27 Â· å‘¨ä¸€

### è®¡åˆ’

- [x] å®Œæˆgrafanaè®¾è®¡

  - [x] æˆåŠŸç‡
  - [x] qps
  - [x] è€—æ—¶

- [ ] å®Œæˆéƒ¨åˆ†centos

  - https://10.226.57.169:5703/vnc.html

- [x] å°†Metricæ³¨å†Œæå–å‡ºæ¥ï¼Œæå‡ä»£ç çš„å¤ç”¨

- [x] è®¾è®¡metricsç»“æ„ä½“ï¼ˆæ„Ÿè§‰æœ‰ç‚¹è¶Šæ”¹è¶Šä¸æ–¹ä¾¿ï¼‰

- [x] è€—æ—¶è®¡ç®—æ–¹æ³•ç”±åŸæ¥çš„ `ï¼ˆè¯·æ±‚æ€»æ•° / æ€»è€—æ—¶æ—¶é—´ï¼‰`ä¿®æ”¹ä¸º `ï¼ˆè¯·æ±‚æ—¶çš„ç»“æŸæ—¶é—´ - è¯·æ±‚æ—¶çš„å¼€å§‹æ—¶é—´ï¼‰`

- [x] grafanaå°†labelsçš„é€‰æ‹©ç­›é€‰åŠŸèƒ½å®ç°

  - grafanaçš„Variabelsï¼Œå…³äºprometheusæ•°æ®æºçš„Queryæ ¼å¼

    ![image-20230227162346039](D:\å®ä¹ ä»“åº“\Daily_notes\images\Snipaste_2023-02-27_16-24-12.png)

app=~"$app",mode=~"$mode",f_size=~"$f_size",ext=~"$ext",http_code=~"$http_code",biz=~"$biz",scene=~"$scene",code=~"$code"



## 2023-2-28 Â· å‘¨äºŒ

### ç–‘æƒ‘

- [x] å°†grafanaçš„ä¸‹æ‹‰é€‰é¡¹é»˜è®¤è®¾ç½®ä¸ºALLåï¼Œå‡ºç°å›¾åƒç»´åº¦åˆ†è£‚çš„é—®é¢˜ï¼ŒåŸå› ä¸ºallä¸ºæˆ–æ“ä½œï¼Œä¼šå°†æ‰€æœ‰è¯¥ç»´åº¦çš„å›¾åƒéƒ½æ˜¾ç¤ºåœ¨ä¸€å¼ å›¾ä¸Šï¼Œ`è§£æå¤§è½¬ç›˜`æ ·ä¾‹ä¸­çš„allå®åˆ™ä¸ºå‡ALLï¼Œå³ä¸‹æ‹‰åŠŸèƒ½ä¸å›¾åƒåŠŸèƒ½æœªå…³è”åœ¨ä¸€èµ·ã€‚åˆæ­¥åˆ¤æ–­è§£å†³æ–¹æ³•ä¸ºç»™ALLè®¾ç½®é»˜è®¤çš„labelå€¼ï¼Œä½¿å…¶é»˜è®¤ç›‘è§†æŸä¸€ä¸ªç»´åº¦ï¼›æˆ–è€…å†å»ºæ–°è¡¨ï¼Œå¿½ç•¥å…¨éƒ¨ç»´åº¦ã€‚**ï¼ˆèšåˆæ“ä½œè§£å†³ï¼‰**

### è®¡åˆ’

- [x] æ›´å¤šgrafanaçš„å›¾ï¼Œå¦‚ä½¿ç”¨legendçš„åˆ†ä½æ•°
- [x] æ‰“åŒ…è„šæœ¬ï¼Œç»™ä½•è€å¸ˆæµ‹è¯•
- [x] å®Œæˆå››é¢˜



**èšåˆæ“ä½œå¯ç”¨by**



## 2023-3-1 Â· å‘¨ä¸‰

![image-20230301101637150](D:\å®ä¹ ä»“åº“\Daily_notes\images\image-20230301101637150.png)

### è®¡åˆ’

- [ ] ~~Gafana - Promethuesæäº¤å®¡æ ¸è¯•è¿è¡Œï¼ˆæ”¹å¤©~~ï¼‰
- [x] å®Œæˆä¸¤é¢˜
- [x] å¼€å§‹ks3ä¿®æ”¹ï¼ˆæŠ½è±¡åŒ–æ¥å£ï¼‰
- [x] åŒºåˆ†æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼ˆä¿®æ”¹labelåŠ åç¼€devï¼Œé¢æ¿æ ‡é¢˜ä¿®æ”¹ä¸ºdevç­‰æ–¹å¼ï¼‰

### è¿‡ç¨‹

![image-20230301180522483](D:.\images\image-20230301180522483.png)

```go
// ä¸€ä¸ªæ¥å£çš„ä¾‹å­

type MyInterface interface{
    Print()
}

func TestFunc(x MyInterface) {}
type MyStruct struct {}
func (me MyStruct) Print() {}

func main() {
    var me MyStruct
    TestFunc(me)
}
```



## 2023-3-2 Â· å‘¨å››

### è®¡åˆ’

- [x] ç»§ç»­å­¦ä¹ go
- [x] ks3æ¥å£æŠ½è±¡
  - `IsExist`
  - `Upload`
  - `Download`
  - `GenerateUrl`
- [ ] ç¼–ç åä¸ºäº‘obsåº•å±‚é€»è¾‘
- [x] ä¿®æ”¹kapiçš„éƒ¨åˆ†æ–¹æ³•
- [x] prometheuséƒ¨åˆ†ï¼Œæå–initialå‡ºæ¥ï¼Œç›´æ¥è°ƒç”¨request.goçš„beforeå’Œafteræ¥æå‡å¤ç”¨ï¼ˆæ•ˆæœï¼Œå†æ·»åŠ ç›‘æ§éœ€æ±‚æ—¶ï¼Œåªéœ€è¦è°ƒç”¨æŠ½è±¡å‡ºçš„initialï¼Œç„¶åç›´æ¥è¿”å›mcounteræ¥è°ƒç”¨beforeå’Œafterï¼‰



## 2023-3-3 Â· å‘¨äº”

### è®¡åˆ’

- [x] è°ƒè¯•grafana
- [x] ç¼–ç åä¸ºäº‘obs
- [ ] æµ‹è¯•ä»£ç å¯è¡Œæ€§



# ğŸŒ´2023-3-4â€”â€”2023-3-5 Â· å‘¨æœ«ingğŸŒ´





## 2023-3-6 Â· å‘¨ä¸€

### è®¡åˆ’

- æµ‹è¯•ä»£ç å¯è¡Œæ€§
  1. ä¸Šä¼ 
     - [x] Upload
     - [x] UploadText
     - [x] UploadByte
     - [x] UploadString
  2. ä¸‹è½½
     - [x] Download
     - [x] DownloadTextByKey
  3. æ ¹æ®keyåˆ¤æ–­æ˜¯å¦å­˜åœ¨
     - [x] IsExist
  4. ç”Ÿæˆä¸‹è½½url
     - [x] GenerateUrl
     - [x] GeneratePubUrlï¼ˆ<u>*å¾…å•†è®®æ›¿æ¢è§„åˆ™*</u>ï¼‰

![](D:\å®ä¹ ä»“åº“\Daily_notes\images\æ–¹æ³•.png)



- å¾ªç¯ä¾èµ–é—®é¢˜è§£å†³åŠæ³•(ks3æ•´ä½“ç§»åŒ…ï¼ŒåŸåŒ…åªç•™ä¸‹é€ æˆå¾ªç¯ä¾èµ–çš„ä¸¤ä¸ªæ–¹æ³•æŒ‡å‘æ–°åŒ…)

  - <img src=".\images\ks3(old).png" style="zoom: 50%;" />

  - <img src=".\images\ks3(new).png" style="zoom: 50%;" />

- æ•´ä½“ç»“æ„

  <img src="D:\å®ä¹ ä»“åº“\Daily_notes\images\cloudservice.png" style="zoom:67%;" />



### é—®é¢˜

grafanaé—®é¢˜è®°å½•

- [x] è€—æ—¶åˆ†ä½æ•°å‡ºç°æ•°æ®åˆå¹¶ç°è±¡
  - ç»æ’æŸ¥ä¸ºè„šæœ¬ä¼ é€’æ•°æ®å•ä½ä¸bucketé…ç½®ä¸ä¸€è‡´ï¼Œè„šæœ¬ä¼ é€’æ•°æ®å•ä½ä¸ºmsè€Œbucketé…ç½®ä¸Šé™ä¸º1800å¯¼è‡´å…¨éƒ¨æ•°æ®å“åº”æ—¶é•¿å‡è¶…å‡ºä¸Šé™ï¼Œä»è€Œå‡ºç°æ•°æ®åˆå¹¶ç°è±¡
- [x] QPSå¢æ·»ç»´åº¦
  - å½“å‰
  - æ˜¨å¤©
  - ä¸Šå‘¨
  - å¢æ·»æ–°pannelï¼ŒæˆåŠŸä¸å¤±è´¥qps
- [x] æˆåŠŸç‡å’Œå¹³å‡è€—æ—¶ä¿®æ”¹ä¸ºæŠ˜çº¿å›¾
  - å½“å‰
  - æ˜¨å¤©
  - ä¸Šå‘¨





## 2023-3-7 Â· å‘¨äºŒ

### æ¢ç´¢

grafanaæ–°æ“ä½œï¼š

1. overridesæ“ä½œå¯è¦†ç›–ä½†è¡¨æ ¼å¤šå›¾çš„ä¸åŒå›¾æ ·å¼
2. standard optionsçš„color schemeæ“ä½œå¯æ›´æ”¹å›¾é¢œè‰²
3. transformæœ‰å¾ˆå¤šéªšæ“ä½œ
4. legendçš„min stepå’Œresolutionå‚æ•°å¯ä»¥è®¾ç½®æœ€å°æ­¥é•¿å’Œå°†å¤šä¸ªæ•°æ®æ ·æœ¬åˆå¹¶æˆä¸€ä¸ªç‚¹
5. value mappingså¯åšæ•°å€¼æ˜ å°„
6. **repeat optionsé€‰é¡¹é…åˆVariableå¯å®ç°é€‰æ‹©å¤šä¸ªlabelå€¼åï¼Œè‡ªåŠ¨äº§ç”Ÿä¸åŒlabelçš„å½“å‰å›¾ï¼Œå¯è¿›è¡Œå¯¹æ¯”ï¼ˆåŒ…æ‹¬æ¨ªå‘å’Œçºµå‘å±•å¼€ï¼‰**
7. **data linksé€‰é¡¹é…åˆVariableå¯å®ç°é¢æ¿é—´çš„æ•°æ®è·³è½¬ï¼Œå†é…åˆrepeat optionså¯å®ç°å…¨å±æŸ¥çœ‹å›¾æ ‡ï¼Œç‚¹å‡»æŠ˜çº¿å›¾æ•°æ®ç›´æ¥è·³è½¬åˆ°å®æ—¶å±•å¼€ç”Ÿæˆçš„æ–°å›¾**

å‚è€ƒé“¾æ¥ï¼š

1. https://www.51cto.com/article/688668.html
2. https://juejin.cn/post/7162088398784725022



grafanaç›‘æ§æŠ¥è­¦ï¼š

- 163é‚®ç®±æˆæƒç ï¼š`PWOGFJTMFZKGKXQC`
- ä¿®æ”¹`conf/default.ini`ä¸­å…³äº`[smtp]`çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶å¼€å¯`[alerting]`çš„é…ç½®
- åœ¨grafanaçš„alertingä¸­è®¾ç½®emailé…ç½®
- åœ¨å›¾è¡¨ä¸­è¯¦ç»†è®¾ç½®æŠ¥è­¦è§„åˆ™ï¼ˆå¾…è¯¦ç»†å­¦ä¹ ï¼‰





## 2023-3-8 Â· å‘¨ä¸‰

### è®¡åˆ’

æ²¡æœ‰è®¡åˆ’ï¼Œæ‰¾äº‹æƒ…åš

åˆ˜è€å¸ˆçš„ä»»åŠ¡ï¼š

- [x] QPSèŠ±æ ·é¢æ¿
  - metric: counter
  - labels:
    - Biz
    - PolicyFlag
    - Status
- [x] å­¦ä¹ ES
- [ ] å­¦ä¹ Kafka



## 2023-3-9 Â· å‘¨å››

### è®¡åˆ’

- [ ] ä¿®æ”¹æ—§é¢æ¿ï¼šè§£æç›‘æ§ä¸€
- [x] æ‰“åŒ…æ–°é¢æ¿ï¼šè§£æç›‘æ§äºŒ
- [x] æ–°å¢æ–°é¢æ¿ï¼šè§£æç›‘æ§ä¸‰



### è¿‡ç¨‹

```go
type ManualLog struct {
    Uuid          string  `json:"uuid"`
    Userid        int64   `json:"userid"`
    Fileid        string  `json:"fileid"`
    Fileinx       string  `json:"fileinx"`
    ExtraId       string  `json:"extra_id"`
    Scene         string  `json:"scene"`
    ExtendId      string  `json:"extend_id"`
    CreateTime    int64   `json:"create_time"`
    LinkCtime     int64   `json:"link_ctime"`
    ModifyTime    int64   `json:"modify_time"`
    Score         float64 `json:"score"`
    Status        string  `json:"status"`
    
    Type          int     `json:"type"`
    Fname         string  `json:"fname"`
    
    Fsha          string  `json:"fsha"`
    From          string  `json:"from"`
    Fsize         int64   `json:"fsize"`
    
    External      string  `json:"external"`
    Operation     string  `json:"operation"`
    OperationTime int64   `json:"operation_time"`
    
    ReviewerId    int64   `json:"reviewer_id"`
    ReviewerName  string  `json:"reviewer_name"`
    Pvless        int64   `json:"pvless"`
    Supplier      string  `json:"supplier"`
    ManualCost    int64   `json:"manual_cost"`
    DelayTime     string  `json:"delay_time"`
    Entry         string  `json:"entry"`
    
    ManAccess     string  `json:"manaccess"`
    ViewTime      int64   `json:"viewTime"`
    
    CheckTime     int64   `json:"checkTime"`
    BuriedStatus  int64   `json:"buriedPointStatus"`
    
    Company       string  `json:"company"`
    PolicyFlag    string  `json:"policy_flag"`
}
```

è§£æç›‘æ§ä¸‰ï¼š

ä»¥ä¸‹ä¸¤ä¸ªä¸ºhistogram

- [ ] bizã€entryã€viewTime ï¼šæŒ‰ç…§å…¥å£å±•ç¤ºå®¡æ ¸é¢„è§ˆè€—æ—¶ 

- [ ] bizã€entryã€OperationTime å®¡æ ¸è€—æ—¶ï¼šæŒ‰ç…§å…¥å£å±•ç¤ºå®¡æ ¸è€—æ—¶ 



ä»¥ä¸‹å››ä¸ªä¸ºcounterï¼š

- [ ] bizã€buriedStatusã€fnameæ— æ³•é¢„è§ˆï¼šå±•ç¤ºæ€»é‡å’Œæ¯ä¸ªæ ¼å¼é‡çº§å˜åŒ–âœ”
- [ ] bizã€fnameã€fsize æŒ‰<u>å¤§å°æ–‡ä»¶</u>ï¼ˆ200MåŒºåˆ†ï¼‰å’Œ<u>æ–‡ä»¶æ ¼å¼</u>åˆ†ç±»ï¼šå±•ç¤ºæ€»é‡å’Œæ¯ä¸ªæ ¼å¼é‡çº§å˜åŒ–âœ”
- [ ] bizã€entryã€status  æŒ‰ç…§<u>æ–‡ä»¶å…¥å£</u>ã€<u>å®¡æ ¸çŠ¶æ€</u>ï¼šå±•ç¤ºæ€»é‡å’Œæ¯ä¸€ä¸ªå…¥å£å®¡æ ¸çŠ¶æ€é‡çº§å˜åŒ–âœ”
- [ ] bizã€fnameã€status æŒ‰ç…§<u>æ–‡ä»¶æ ¼å¼</u>ã€<u>å®¡æ ¸çŠ¶æ€</u>ï¼šå±•ç¤ºæ€»é‡å’Œæ¯ä¸€ç§æ–‡ä»¶æ ¼å¼å®¡æ ¸çŠ¶æ€é‡çº§å˜åŒ–âœ”



```go
type LabelV3 struct {
	Biz           string `json:"Biz"`
	Status        string `json:"status"`
	Fname         string `json:"fname"`
	Fsize         int64  `json:"fsize"`
	OperationTime int64  `json:"operation_time"`
	Entry         string `json:"entry"`
	ViewTime      int64  `json:"viewTime"`
	BuriedStatus  int64  `json:"buriedPointStatus"`
}
```



åˆ¶å®šmetrics:

- `fcheck_test_viewtime_cost_seconds`
- `fcheck_test_operationtime_cost_seconds`
- `fcheck_test_extract_files_total`



### é—®é¢˜

1. å› ä¸º`OperationTime`å’Œ`ViewTime`å‡ä»¥labelå½¢å¼æ”¾åœ¨ç»“æ„ä½“ä¸­ï¼Œæ— æ³•ä½¿ç”¨`histogramã€counterã€gaugeã€summary`ç­‰æ–¹å¼å†™å…¥æ—¶é—´
   - è§£å†³æ–¹æ³•ï¼šä¿®æ”¹`AfterMonitor()`è„šæœ¬ï¼Œæ–°å¢å‚æ•°ï¼Œå¯æ‰‹åŠ¨å†™å…¥æ•°æ®
2. æ¶‰åŠç»“æ„ä½“çš„æˆå‘˜å˜é‡çš„ç±»å‹è½¬æ¢ï¼šint64 -> string
3. mcä¸å¯å¤ç”¨

